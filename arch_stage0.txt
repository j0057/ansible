#!/bin/bash

message() {
    echo -en "\n\e[1;37m==> $1\e[0;0m\n\n"
}
export -f message

lines() {
    target="$1"
    message "Configuring $target"
    shift
    while [ -n "$1" ]; do
        echo "$1" >> "$target"
        shift
    done
}
export -f lines

partition() {
    disk=$1 ; shift
    i=0 ; while [ "$#" -gt 0 ]; do args[i++]=$1 ; shift ; done

    message "Partitioning"
    sgdisk $disk --zap-all
    for (( i=1 ; i <= ${#args[*]} ; i++ )) ; do
        for (( j=0 ; j < ${#args[*]} ; j++ )) ; do
            read index size typecode label fstype mountpoint <<< "${args[j]}"
            if [ "${index}" = "${i}" ]; then
                sgdisk ${disk} --new ${i}:${size} --typecode ${i}:${typecode} --change-name ${i}:${label}
                break
            fi
        done
    done
    sgdisk --print

    message "Formatting"
    for (( j=0 ; j < ${#args[*]} ; j++ )) ; do
        read index size typecode label fstype mountpoint <<< "${args[j]}"
        case ${fstype} in
            ext4)
                mkfs.ext4 -L ${label} ${disk}${index}
                ;;
            btrfs)
                mkfs.btrfs -L ${label} ${disk}${index}
                ;;
            swap)
                mkswap -L ${label} ${disk}${index}
                ;;
        esac
    done

    message "Mounting"
    for (( j=0 ; j < ${#args[*]} ; j++ )) ; do
        read index size typecode label fstype mountpoint <<< "${args[j]}"
        case ${fstype} in
            swap)
                swapon /dev/${disk}${index}
                ;;
            *)
                mkdir -v -p /mnt${mountpoint}
                mount -v LABEL=${label} /mnt${mountpoint}
                ;;
        esac
    done
}
export -f partition

INSTALL_PACKAGES=$(sed 's/\s\+/ /g' <<< "${INSTALL_PACKAGES//$'\n'/ }")
INSTALL_SERVICES=$(sed 's/\s\+/ /g' <<< "${INSTALL_SERVICES//$'\n'/ }")

for var in `set | sed -n '/^INSTALL_/s/=.*//p'`; do
    read -p "$var: " -e -i "${!var}" $var 0<&4
done

message "Starting stage 1"
bash -e <(curl -sv "http://${INSTALL_HOST}/arch_stage1.txt")

message "Starting stage 2 in chroot"
arch-chroot /mnt bash -e <(curl -sv "http://${INSTALL_HOST}/arch_stage2.txt")

message "Unmounting"
umount -R /mnt
swapoff -a
