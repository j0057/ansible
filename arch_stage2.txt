#!/bin/bash -e

message "Environment:"
set

message "Setting hostname to ${INSTALL_HOSTNAME}"
echo "${INSTALL_HOSTNAME}" > /etc/hostname

message "Setting timezone to ${INSTALL_TZNAME}"
ln -sf "/usr/share/zoneinfo/${INSTALL_TZNAME}" /etc/localtime

message "Generating locale ${INSTALL_LOCALE}"
echo "${INSTALL_LOCALE}" >> /etc/locale.gen
locale-gen

message "Setting locale to ${INSTALL_LOCALE}"
echo "LANG=${INSTALL_LOCALE}" > /etc/locale.conf

message "Creating initial ram disk"
mkinitcpio -p linux

message "Setting password to root"
echo -en "root\nroot\n" | passwd root

message "Installing GRUB"
grub-install --target=i386-pc --recheck /dev/sda
grub-mkconfig -o /boot/grub/grub.cfg

message "Enabling services"
systemctl enable sshd.service

message "Enabling SSH to root"
mkdir /root/.ssh
touch /root/.ssh/authorized_keys
echo "${INSTALL_PUBKEYS}" > /root/.ssh/authorized_keys
chmod 0700 /root/.ssh
chmod 0600 /root/.ssh/authorized_keys

message "Installing pip"
curl -s "https://bootstrap.pypa.io/get-pip.py" > /tmp/get-pip.py
python2 /tmp/get-pip.py --user
echo 'PATH=$PATH:$HOME/.local/bin' > '/etc/profile.d/local-bin.sh'
