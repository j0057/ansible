#!/bin/bash -e
# curl -sv http://j0057.github.io/ansible/arch-vbox-1.txt | bash -e
# curl -sv http://example.com/arch-vbox-1.txt | bash -es example.com

message() { echo ; echo -e "\e[1;37m==> $1\e[0;0m" ; echo ; }
export -f message

export INSTALL_HOST="${1:-j0057.github.io/ansible}"
export INSTALL_HOSTNAME="arch-vbox-1"
export INSTALL_TZNAME="Europe/Amsterdam"
export INSTALL_LOCALE="en_US.UTF-8 UTF-8"
export INSTALL_PACKAGES="btrfs-progs grub openssh python2 lsb-release git"
export INSTALL_PUBKEYS=(
    "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDimLdgtdlheQ01ma2VVcDzzE1bsaL58RumZa7IPri5o1MhNlKVwLYumz6lTLuoLS/CU4UOKWtafISo6tQSQZH4Wjz/B/sz6ken2W6LSjiAwahgcONSsrxIAYykXyLoYPifmQDdm6Fic5L9WVfJI8H69hxmCQv+6WIorsLCGMZ4+hjWwrRcbQjNGCzqEWbszpphJ21ZlW3WCYafSm4o7u0aCWPjW8ln3BhdogO4A061nYtCZxtU3dqiLyuhzRkXxAjtUsjqRpOTFxBwn3xgoXomhIcKJSFeKVRH0PmoZOWfp+l8KIiztc3dYVrh6eIsk/efbSk5x4q9L8vw+KPQ2cZRf/CIY6sC9n5Zodyu2LxDPmJQOea1s+LgmXExtkVfM0q5UJc4Kqifz2aCHlbkhvBV+Mjx50eBe9otHO0G7ebJMDRqF0aTUYJDABz/LaqnkoerHYmN2iPEsiqVgI0K1AsFrPDtrr41b6dtGkcc0t+SJkN+QeSWq3AUi4LG4PcHHLi9w5W2RSOIMooCqWTUGTSAKrBDUwCpaOc/ict2//kNcHjYGB3uj4FHkOXGvyAt3Zk7HQa79vqjzsEaMBetkcxbrwF0gO1RFbiccBUZnM2VLbplE+53SSlyymVUZ2rFVo0qr0r1fGWiit0k0G9cCCmuRzas+CeJx2JDZDU2A6tGnw== j.j.molenaar@gmail.com"
    "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCb/tQGJK0urxXgVtpAPL+MkAHvW0DG5ovN85xn+2cNSAbjtrXkMuvoLa8W8ctqejIBLYwUYHtcmDjGweKJeZxQcoXwY9vBj6Ai1HJUKG88i90vn4x/FKRzuffmoMYLVKs1UHqCVzM2ECzvvzT5nD0aFUvHCFmfWW6G2gt23bJKzjJfb0l7AdoZwzCYAvylK/Q5MGB6jbkNNX9Vo7p7r8G9FfOIxd3Sxms5FVbx2wlo9RyEfA8QKFLrRAcX2rzOhPGtbrmZ5GQ6DH3fnlCVB3hSGH4sfCYjP5H2yIbgALy337Bv2Rqrv66sFJXOzQ5KwHlQg5srFMj8A93rhHqK7NSt jjm@nexus5"
    "ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAQEAu+IbAxxaQCXhuGDkT1d7fPgRyU7gggeMfnQcV23Q2kfIMekJYXEUgkZAHA5F5URAtW81NVEB8wl8szF5UUlq4M6j9cmeXYCSPWxccJ6xbIlLUk9m6/1HX9QYEJYRYEk/ZUj1jQK2YymQU0nOI6oPeGc6Oz06qtXPXJuoKJO8TJhfIxJE8EEeXS4otXmKuJEZ2eajNzp1LdRcHGvbz8MWVI7uD9yxbzmrLC+6CKYPAE+oj7vrtWh2WUphy2AaowZxO3kMJzjSeq6hh/53gWVhYR2pQt1aiJTwxLE0NdXqaI/5PGwrM86aBEYaE/6dn6sBRLwqxTvorSoPa+IJjCK3Ow== joost@ws-nuc41.schoolmaster.nl"
)

message "Starting stage 1"
curl -sv "http://${INSTALL_HOST}/arch_stage1.txt" | bash -e

message "Starting stage 2 in chroot"
arch-chroot /mnt bash -c "curl -sv \"http://${INSTALL_HOST}/arch_stage2.txt\" | bash -e"

message "Configuring enp0s3"
cat > /mnt/etc/netctl/eth0-dhcp << EOF
Interface=enp0s3
Connection=ethernet
IP=dhcp
EOF
arch-chroot /mnt netctl enable eth0-dhcp

message "Unmounting"
umount -R /mnt
