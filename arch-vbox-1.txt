#!/bin/bash -e

# run directly from github.io:
# curl -sv j0057.github.io/ansible/arch-vbox-1.txt | bash -e |& tee install.log

# run from development environment (note repeated hostname to bash invocation):
# curl -sv example.com/arch-vbox-1.txt | bash -es example.com |& tee install.log

message() { echo ; echo -e "\e[1;37m==> $1\e[0;0m" ; echo ; }
export -f message

export INSTALL_HOST="${1:-j0057.github.io/ansible}"
export INSTALL_HOSTNAME="arch-vbox-1"
export INSTALL_TZNAME="Europe/Amsterdam"
export INSTALL_LOCALE="en_US.UTF-8 UTF-8"
export INSTALL_PACKAGES="openssh python2 lsb-release git base-devel"

message "Starting stage 1"
curl -sv "http://${INSTALL_HOST}/arch_stage1.txt" | bash -e

message "Starting stage 2 in chroot"
arch-chroot /mnt bash -c "curl -sv \"http://${INSTALL_HOST}/arch_stage2.txt\" | bash -e"

message "Configuring enp0s3"
cat > /mnt/etc/netctl/eth0-dhcp << EOF
Interface=enp0s3
Connection=ethernet
IP=dhcp
EOF
arch-chroot /mnt netctl enable eth0-dhcp

message "Configuring enp0s8"
cat > /mnt/etc/netctl/eth1-static<< EOF
Interface=enp0s8
Connection=ethernet
IP=static
Address=("10.101.0.66/16")
EOF
arch-chroot /mnt netctl enable eth1-static

message "Unmounting"
umount -R /mnt
