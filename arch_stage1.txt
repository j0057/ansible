#!/bin/bash -e

message "Environment:"
set

message "Partitioning"
sgdisk /dev/sda --zap-all
sgdisk /dev/sda --new 1:1M:+1M --typecode 1:ef02 --change-name=1:bios
sgdisk /dev/sda --new 2:0:+256M --typecode 2:8300 --change-name=2:boot
sgdisk /dev/sda --new 3:0:+16G --typecode 3:8300 --change-name=3:root
sgdisk /dev/sda --new 4:0:0 --typecode 4:8300 --change-name=4:home
sgdisk /dev/sda --print

message "Re-reading partition table"
partprobe /dev/sda
sleep 3

message "Formatting"
mkfs.ext4 -L "boot" /dev/sda2
mkfs.ext4 -L "root" /dev/sda3
mkfs.ext4 -L "home" /dev/sda4
#mkfs.btrfs --force --label "root" /dev/sda3

message "Mounting"
mount -v -L root /mnt       ; mkdir -v /mnt/{boot,home}
mount -v -L boot /mnt/boot
mount -v -L home /mnt/home

message "Installing reflector"
pacman --sync --refresh --noconfirm --color always reflector

message "Updating mirror list"
reflector --country NL --latest 10 --protocol http --sort rate --save /etc/pacman.d/mirrorlist

message "Bootstrapping"
pacstrap /mnt $INSTALL_PACKAGES

message "Generating /etc/fstab"
genfstab -L -p /mnt > /mnt/etc/fstab
